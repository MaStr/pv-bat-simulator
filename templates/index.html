<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PV & Batterie Simulator</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            padding: 40px;
        }
        
        h1 {
            color: #333;
            margin-bottom: 10px;
            font-size: 2.5em;
        }
        
        .subtitle {
            color: #666;
            margin-bottom: 30px;
            font-size: 1.1em;
        }
        
        .section {
            margin-bottom: 30px;
            padding: 25px;
            background: #f8f9fa;
            border-radius: 10px;
            border-left: 4px solid #667eea;
        }
        
        .section h2 {
            color: #667eea;
            margin-bottom: 20px;
            font-size: 1.5em;
        }
        
        .input-group {
            margin-bottom: 20px;
        }
        
        label {
            display: block;
            margin-bottom: 8px;
            color: #333;
            font-weight: 600;
        }
        
        input[type="number"], select {
            width: 100%;
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 5px;
            font-size: 1em;
            transition: border-color 0.3s;
        }
        
        input[type="number"]:focus, select:focus {
            outline: none;
            border-color: #667eea;
        }
        
        .grid-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .time-series-input {
            display: grid;
            grid-template-columns: repeat(6, 1fr);
            gap: 10px;
        }
        
        .time-series-input input {
            padding: 8px;
            font-size: 0.9em;
        }
        
        .hour-label {
            display: block;
            font-size: 0.8em;
            color: #666;
            margin-bottom: 5px;
            text-align: center;
        }
        
        button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 15px 40px;
            font-size: 1.1em;
            border-radius: 8px;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            font-weight: 600;
        }
        
        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
        }
        
        button:active {
            transform: translateY(0);
        }
        
        .button-container {
            text-align: center;
            margin: 30px 0;
        }
        
        #ergebnis {
            margin-top: 30px;
        }
        
        .result-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            border-radius: 10px;
            margin-bottom: 20px;
            box-shadow: 0 10px 30px rgba(102, 126, 234, 0.3);
        }
        
        .result-card h3 {
            font-size: 1.3em;
            margin-bottom: 10px;
        }
        
        .result-card .value {
            font-size: 2.5em;
            font-weight: bold;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        
        th, td {
            padding: 15px;
            text-align: center;
            border-bottom: 1px solid #eee;
        }
        
        th {
            background: #667eea;
            color: white;
            font-weight: 600;
            text-transform: uppercase;
            font-size: 0.9em;
            letter-spacing: 0.5px;
        }
        
        tr:hover {
            background: #f8f9fa;
        }
        
        tr:last-child td {
            border-bottom: none;
        }
        
        .loading {
            display: none;
            text-align: center;
            padding: 20px;
        }
        
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .error {
            background: #ff6b6b;
            color: white;
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
        }
        
        .info-box {
            background: #e7f3ff;
            border-left: 4px solid #2196F3;
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 5px;
        }
        
        .battery-params {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
        }
        
        .charts-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
            gap: 30px;
            margin-top: 30px;
        }
        
        .chart-wrapper {
            background: white;
            padding: 25px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        
        .chart-wrapper h3 {
            color: #667eea;
            margin-bottom: 20px;
            font-size: 1.3em;
            text-align: center;
        }
        
        .chart-canvas {
            position: relative;
            height: 300px;
        }
        
        .github-button {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            background: #24292e;
            color: white;
            text-decoration: none;
            padding: 10px 20px;
            border-radius: 8px;
            font-weight: 600;
            font-size: 0.95em;
            transition: background 0.3s, transform 0.2s;
            margin-left: 20px;
            vertical-align: middle;
        }
        
        .github-button:hover {
            background: #40464e;
            transform: translateY(-2px);
        }
        
        .github-button svg {
            width: 20px;
            height: 20px;
            fill: currentColor;
        }
        
        .header-container {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 10px;
        }
        
        .header-left {
            display: flex;
            align-items: center;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header-container">
            <div class="header-left">
                <h1>‚ö° PV & Batterie Simulator</h1>
                <a href="https://github.com/MaStr/pv-bat-simulator" target="_blank" rel="noopener noreferrer" class="github-button">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16">
                        <path d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.013 8.013 0 0016 8c0-4.42-3.58-8-8-8z"/>
                    </svg>
                    GitHub
                </a>
            </div>
        </div>
        <p class="subtitle">Vergleich verschiedener Batteriesteuerungsmodelle</p>
        
        <div class="info-box">
            <strong>‚ÑπÔ∏è Hinweis:</strong> Alle Leistungswerte in Wh (Wattstunden), Preise in ‚Ç¨/kWh
        </div>
        
        <!-- aWATTar Data Fetching Controls -->
        <div class="section" id="section-awattar-controls">
            <h2>üåê aWATTar Datenquelle</h2>
            <div class="battery-params">
                <div class="input-group">
                    <label for="awattar_date">Datum</label>
                    <input type="date" id="awattar_date" name="awattar_date" 
                           value="" style="width: 100%;">
                    <small style="color: #666; margin-top: 5px; display: block;">
                        Aktuelles Datum: <span id="current-date-display"></span>
                    </small>
                </div>
                
                <div class="input-group">
                    <label for="awattar_kwp">Solaranlagengr√∂√üe (kWp)</label>
                    <input type="number" id="awattar_kwp" name="awattar_kwp" 
                           value="10" step="0.5" min="0">
                    <small style="color: #666; margin-top: 5px; display: block;">
                        Installierte Leistung Ihrer PV-Anlage
                    </small>
                </div>
                
                <div class="input-group">
                    <label for="awattar_fee">Zus√§tzliche Geb√ºhr (‚Ç¨/kWh)</label>
                    <input type="number" id="awattar_fee" name="awattar_fee" 
                           value="0.05" step="0.01" min="0">
                    <small style="color: #666; margin-top: 5px; display: block;">
                        Netzentgelte, Abgaben, etc.
                    </small>
                </div>
                
                <div class="input-group">
                    <label for="awattar_vat">Mehrwertsteuer (%)</label>
                    <input type="number" id="awattar_vat" name="awattar_vat" 
                           value="19" step="1" min="0" max="50">
                    <small style="color: #666; margin-top: 5px; display: block;">
                        Standard: 19% in Deutschland
                    </small>
                </div>
            </div>
            
            <div style="margin-top: 20px; display: flex; gap: 10px; flex-wrap: wrap;">
                <button type="button" id="btn-fetch-awattar" class="submit-button" style="flex: 1; min-width: 200px;">
                    üîÑ Daten laden/aktualisieren
                </button>
                <button type="button" id="btn-go-back" class="submit-button" style="flex: 1; min-width: 200px; background: #6c757d;">
                    ‚¨ÖÔ∏è Vorheriger Tag
                </button>
                <button type="button" id="btn-today" class="submit-button" style="flex: 1; min-width: 200px; background: #28a745;">
                    üìÖ Heute
                </button>
            </div>
            
            <div id="awattar-status" style="margin-top: 15px; padding: 10px; border-radius: 5px; display: none;"></div>
        </div>
        
        <!-- Modell-Auswahl -->
        <div class="section">
            <h2>üéØ Modell-Auswahl</h2>
            <div class="input-group">
                <label for="modell">Simulationsmodell w√§hlen</label>
                <select id="modell" name="modell">
                    <option value="1">Modell 1: Linearer Verbrauch - Statischer Preis</option>
                    <option value="2">Modell 2: Linearer Verbrauch - Dynamischer Preis</option>
                    <option value="3">Modell 3: Aktive Steuerung - Dynamischer Preis (Optimiert)</option>
                    <option value="4">Modell 4: BatControl Steuerung - Dynamischer Preis (3-Modi-Logik)</option>
                </select>
            </div>
        </div>
        
        <form id="simulationForm">
            <!-- Statischer Strompreis (nur f√ºr Modell 1) -->
            <div class="section" id="section-statischer-preis">
                <h2>üí∂ Statischer Strompreis</h2>
                <div class="input-group">
                    <label for="statischer_preis">Strompreis (‚Ç¨/kWh)</label>
                    <input type="number" id="statischer_preis" name="statischer_preis" 
                           value="0.30" step="0.01">
                </div>
            </div>
            
            <!-- Dynamische Strompreise (nur f√ºr Modell 2) -->
            <div class="section" id="section-dynamische-preise" style="display: none;">
                <h2>üìä Dynamische Strompreise (‚Ç¨/kWh) - 24 Stunden</h2>
                <div class="time-series-input" id="preise-container">
                    <!-- Preise werden dynamisch geladen -->
                </div>
            </div>
            
            <!-- Verbrauch -->
            <div class="section">
                <h2>üè† Verbrauch (Wh) - 24 Stunden</h2>
                <div class="time-series-input" id="verbrauch-container">
                    <!-- Verbrauch wird dynamisch geladen -->
                </div>
            </div>
            
            <!-- PV-Strom -->
            <div class="section">
                <h2>‚òÄÔ∏è PV-Stromerzeugung (Wh) - 24 Stunden</h2>
                <div class="time-series-input" id="pv-container">
                    <!-- PV-Strom wird dynamisch geladen -->
                </div>
            </div>
            
            <!-- Batterie-Parameter -->
            <div class="section">
                <h2>üîã Batterie-Parameter</h2>
                <div class="battery-params">
                    <div class="input-group">
                        <label for="batterie_kapazitaet">Batteriekapazit√§t (Wh)</label>
                        <input type="number" id="batterie_kapazitaet" name="batterie_kapazitaet" 
                               value="5000" step="100" required>
                    </div>
                    
                    <div class="input-group">
                        <label for="max_lade_leistung">Max. Ladeleistung (W)</label>
                        <input type="number" id="max_lade_leistung" name="max_lade_leistung" 
                               value="3000" step="100" required>
                    </div>
                    
                    <div class="input-group">
                        <label for="max_entlade_leistung">Max. Entladeleistung (W)</label>
                        <input type="number" id="max_entlade_leistung" name="max_entlade_leistung" 
                               value="3000" step="100" required>
                    </div>
                    
                    <div class="input-group" id="preis-abstand-group">
                        <label for="preis_abstand">Preisabstand f√ºr Nachladen (‚Ç¨/kWh)</label>
                        <input type="number" id="preis_abstand" name="preis_abstand" 
                               value="0.05" step="0.01">
                    </div>
                    
                    <div class="input-group">
                        <label for="anfangs_soc">Anfangs-Ladestand (0-100%)</label>
                        <input type="number" id="anfangs_soc" name="anfangs_soc" 
                               value="0" min="0" max="100" step="1">
                        <small style="color: #666; margin-top: 5px; display: block;">
                            Ladestand der Batterie zu Beginn der Simulation (24:00 Uhr)
                        </small>
                    </div>
                </div>
            </div>
            
            <!-- BatControl-Parameter (nur f√ºr Modell 4) -->
            <div class="section" id="section-batcontrol-params" style="display: none;">
                <h2>ü§ñ BatControl Steuerungsparameter</h2>
                <div class="info-box">
                    <strong>‚ÑπÔ∏è BatControl Modus:</strong> Nutzt drei intelligente Modi:
                    <ul style="margin: 10px 0 0 20px;">
                        <li><strong>MODE -1 (Laden):</strong> Batterie aus Netz laden bei niedrigen Preisen</li>
                        <li><strong>MODE 0 (Schonen):</strong> Batterie nicht entladen wenn Preise steigen</li>
                        <li><strong>MODE 10 (Normal):</strong> Batterie normal nutzen</li>
                    </ul>
                </div>
                <div class="battery-params">
                    <div class="input-group">
                        <label for="min_preis_differenz">Mindest-Preisdifferenz (‚Ç¨/kWh)</label>
                        <input type="number" id="min_preis_differenz" name="min_preis_differenz" 
                               value="0.05" step="0.01" min="0">
                        <small style="color: #666; margin-top: 5px; display: block;">
                            Preisunterschied f√ºr aktives Nachladen aus dem Netz
                        </small>
                    </div>
                    
                    <div class="input-group">
                        <label for="always_allow_discharge_limit">Entlade-Freigabe SOC (%)</label>
                        <input type="number" id="always_allow_discharge_limit" name="always_allow_discharge_limit" 
                               value="90" min="0" max="100" step="1">
                        <small style="color: #666; margin-top: 5px; display: block;">
                            Ab diesem Ladestand wird immer entladen (MODE 10)
                        </small>
                    </div>
                    
                    <div class="input-group">
                        <label for="max_charging_from_grid_limit">Max. Netzladung SOC (%)</label>
                        <input type="number" id="max_charging_from_grid_limit" name="max_charging_from_grid_limit" 
                               value="80" min="0" max="100" step="1">
                        <small style="color: #666; margin-top: 5px; display: block;">
                            Maximaler Ladestand beim Laden aus dem Netz
                        </small>
                    </div>
                </div>
            </div>
            
            <div class="button-container">
                <button type="submit">üöÄ Berechnung starten</button>
            </div>
        </form>
        
        <div class="loading" id="loading">
            <div class="spinner"></div>
            <p style="margin-top: 15px; color: #667eea; font-weight: 600;">Berechnung l√§uft...</p>
        </div>
        
        <div id="ergebnis"></div>
    </div>
    
    <script>
        // ===== aWATTar Integration =====
        
        // Initialize date input with today's date
        function initializeDatePicker() {
            const dateInput = document.getElementById('awattar_date');
            const today = new Date().toISOString().split('T')[0];
            dateInput.value = today;
            document.getElementById('current-date-display').textContent = today;
        }
        
        // Show status message
        function showAwattarStatus(message, type = 'info') {
            const statusDiv = document.getElementById('awattar-status');
            statusDiv.style.display = 'block';
            statusDiv.className = '';
            
            if (type === 'success') {
                statusDiv.style.background = '#d4edda';
                statusDiv.style.color = '#155724';
                statusDiv.style.borderLeft = '4px solid #28a745';
            } else if (type === 'error') {
                statusDiv.style.background = '#f8d7da';
                statusDiv.style.color = '#721c24';
                statusDiv.style.borderLeft = '4px solid #dc3545';
            } else {
                statusDiv.style.background = '#d1ecf1';
                statusDiv.style.color = '#0c5460';
                statusDiv.style.borderLeft = '4px solid #17a2b8';
            }
            
            statusDiv.textContent = message;
            
            // Auto-hide after 5 seconds
            setTimeout(() => {
                statusDiv.style.display = 'none';
            }, 5000);
        }
        
        // Fetch data from aWATTar API
        async function fetchAwattarData() {
            const dateInput = document.getElementById('awattar_date');
            const kwpInput = document.getElementById('awattar_kwp');
            const feeInput = document.getElementById('awattar_fee');
            const vatInput = document.getElementById('awattar_vat');
            
            const date = dateInput.value;
            const kwp = parseFloat(kwpInput.value);
            const fee = parseFloat(feeInput.value);
            const vat = parseFloat(vatInput.value);
            
            if (!date) {
                showAwattarStatus('Bitte w√§hlen Sie ein Datum aus.', 'error');
                return;
            }
            
            showAwattarStatus('Lade Daten von aWATTar...', 'info');
            
            try {
                // Fetch pricing data
                const pricesResponse = await fetch(`/api/prices?date=${date}&fee=${fee}&vat=${vat}`);
                const pricesData = await pricesResponse.json();
                
                if (!pricesData.success) {
                    throw new Error(pricesData.error || 'Fehler beim Laden der Preisdaten');
                }
                
                // Fetch production data
                const productionResponse = await fetch(`/api/production?date=${date}&kwp=${kwp}`);
                const productionData = await productionResponse.json();
                
                if (!productionData.success) {
                    throw new Error(productionData.error || 'Fehler beim Laden der Produktionsdaten');
                }
                
                // Update UI with fetched data
                updatePricesFromAwattar(pricesData.data);
                updateProductionFromAwattar(productionData.data);
                
                // Update current date display
                document.getElementById('current-date-display').textContent = date;
                
                showAwattarStatus(`‚úì Daten f√ºr ${date} erfolgreich geladen!`, 'success');
            } catch (error) {
                showAwattarStatus(`Fehler: ${error.message}`, 'error');
                console.error('aWATTar fetch error:', error);
            }
        }
        
        // Update price inputs with aWATTar data
        function updatePricesFromAwattar(pricesData) {
            const preiseContainer = document.getElementById('preise-container');
            
            // Clear existing inputs
            preiseContainer.innerHTML = '';
            
            // Sort by hour to ensure correct order
            pricesData.sort((a, b) => a.hour - b.hour);
            
            for (let i = 0; i < 24; i++) {
                const priceEntry = pricesData.find(p => p.hour === i);
                const price = priceEntry ? priceEntry.final_price : 0;
                
                preiseContainer.innerHTML += `
                    <div>
                        <span class="hour-label">${String(i).padStart(2, '0')}:00</span>
                        <input type="number" step="0.0001" name="preis_${i}" value="${price.toFixed(4)}" required>
                    </div>
                `;
            }
        }
        
        // Update PV production inputs with aWATTar data
        function updateProductionFromAwattar(productionData) {
            const pvContainer = document.getElementById('pv-container');
            
            // Clear existing inputs
            pvContainer.innerHTML = '';
            
            // Sort by hour to ensure correct order
            productionData.sort((a, b) => a.hour - b.hour);
            
            for (let i = 0; i < 24; i++) {
                const prodEntry = productionData.find(p => p.hour === i);
                // Convert kWh to Wh
                const pvValue = prodEntry ? Math.round(prodEntry.solar_kwh * 1000) : 0;
                
                pvContainer.innerHTML += `
                    <div>
                        <span class="hour-label">${String(i).padStart(2, '0')}:00</span>
                        <input type="number" step="1" name="pv_${i}" value="${pvValue}" required>
                    </div>
                `;
            }
        }
        
        // Go back one day
        function goBackOneDay() {
            const dateInput = document.getElementById('awattar_date');
            const currentDate = new Date(dateInput.value);
            currentDate.setDate(currentDate.getDate() - 1);
            dateInput.value = currentDate.toISOString().split('T')[0];
            fetchAwattarData();
        }
        
        // Go to today
        function goToToday() {
            const dateInput = document.getElementById('awattar_date');
            const today = new Date().toISOString().split('T')[0];
            dateInput.value = today;
            fetchAwattarData();
        }
        
        // ===== End aWATTar Integration =====
        
        // Beispieldaten beim Laden der Seite abrufen
        document.addEventListener('DOMContentLoaded', async function() {
            // Initialize aWATTar controls
            initializeDatePicker();
            
            // Add event listeners for aWATTar buttons
            document.getElementById('btn-fetch-awattar').addEventListener('click', fetchAwattarData);
            document.getElementById('btn-go-back').addEventListener('click', goBackOneDay);
            document.getElementById('btn-today').addEventListener('click', goToToday);
            
            try {
                const response = await fetch('/beispieldaten');
                const data = await response.json();
                
                // Verbrauchsdaten laden
                const verbrauchContainer = document.getElementById('verbrauch-container');
                verbrauchContainer.innerHTML = '';
                for (let i = 0; i < 24; i++) {
                    verbrauchContainer.innerHTML += `
                        <div>
                            <span class="hour-label">${String(i).padStart(2, '0')}:00</span>
                            <input type="number" step="1" name="verbrauch_${i}" value="${data.verbrauch[i]}" required>
                        </div>
                    `;
                }
                
                // PV-Daten laden
                const pvContainer = document.getElementById('pv-container');
                pvContainer.innerHTML = '';
                for (let i = 0; i < 24; i++) {
                    pvContainer.innerHTML += `
                        <div>
                            <span class="hour-label">${String(i).padStart(2, '0')}:00</span>
                            <input type="number" step="1" name="pv_${i}" value="${data.pv_strom[i]}" required>
                        </div>
                    `;
                }
                
                // Preisdaten laden
                const preiseContainer = document.getElementById('preise-container');
                preiseContainer.innerHTML = '';
                for (let i = 0; i < 24; i++) {
                    preiseContainer.innerHTML += `
                        <div>
                            <span class="hour-label">${String(i).padStart(2, '0')}:00</span>
                            <input type="number" step="0.01" name="preis_${i}" value="${data.preise[i]}">
                        </div>
                    `;
                }
                
                // Anfangs-SOC ist jetzt immer sichtbar in den allgemeinen Batterie-Parametern
                
            } catch (error) {
                console.error('Fehler beim Laden der Beispieldaten:', error);
            }
        });
        
        // Modell-Wechsel Handler
        document.getElementById('modell').addEventListener('change', function() {
            const modell = parseInt(this.value);
            const sectionStatisch = document.getElementById('section-statischer-preis');
            const sectionDynamisch = document.getElementById('section-dynamische-preise');
            const preisAbstandGroup = document.getElementById('preis-abstand-group');
            const sectionBatcontrol = document.getElementById('section-batcontrol-params');
            
            if (modell === 1) {
                sectionStatisch.style.display = 'block';
                sectionDynamisch.style.display = 'none';
                preisAbstandGroup.style.display = 'block';
                sectionBatcontrol.style.display = 'none';
                document.getElementById('statischer_preis').required = true;
            } else if (modell === 2) {
                sectionStatisch.style.display = 'none';
                sectionDynamisch.style.display = 'block';
                preisAbstandGroup.style.display = 'none';
                sectionBatcontrol.style.display = 'none';
                document.getElementById('statischer_preis').required = false;
            } else if (modell === 3) {
                sectionStatisch.style.display = 'none';
                sectionDynamisch.style.display = 'block';
                preisAbstandGroup.style.display = 'block';
                sectionBatcontrol.style.display = 'none';
                document.getElementById('statischer_preis').required = false;
            } else if (modell === 4) {
                sectionStatisch.style.display = 'none';
                sectionDynamisch.style.display = 'block';
                preisAbstandGroup.style.display = 'none';
                sectionBatcontrol.style.display = 'block';
                document.getElementById('statischer_preis').required = false;
            }
        });
        
        document.getElementById('simulationForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            // Loading anzeigen
            document.getElementById('loading').style.display = 'block';
            document.getElementById('ergebnis').innerHTML = '';
            
            // Daten sammeln
            const formData = new FormData(e.target);
            const modell = parseInt(document.getElementById('modell').value);
            
            const verbrauch = [];
            const pv_strom = [];
            
            for (let i = 0; i < 24; i++) {
                verbrauch.push(parseFloat(formData.get(`verbrauch_${i}`)));
                pv_strom.push(parseFloat(formData.get(`pv_${i}`)));
            }
            
            const data = {
                modell: modell,
                verbrauch: verbrauch,
                pv_strom: pv_strom,
                batterie_kapazitaet: parseFloat(formData.get('batterie_kapazitaet')),
                max_lade_leistung: parseFloat(formData.get('max_lade_leistung')),
                max_entlade_leistung: parseFloat(formData.get('max_entlade_leistung'))
            };
            
            // Gemeinsamer Anfangs-SOC f√ºr alle Modelle
            data.anfangs_soc = parseFloat(formData.get('anfangs_soc')) / 100.0;  // Konvertiere % in Dezimalzahl
            
            // Modell-spezifische Daten hinzuf√ºgen
            if (modell === 1) {
                data.statischer_preis = parseFloat(formData.get('statischer_preis'));
                data.preis_abstand = parseFloat(formData.get('preis_abstand'));
            } else if (modell === 2) {
                const preise = [];
                for (let i = 0; i < 24; i++) {
                    preise.push(parseFloat(formData.get(`preis_${i}`)));
                }
                data.preise = preise;
            } else if (modell === 3) {
                const preise = [];
                for (let i = 0; i < 24; i++) {
                    preise.push(parseFloat(formData.get(`preis_${i}`)));
                }
                data.preise = preise;
                data.preis_abstand = parseFloat(formData.get('preis_abstand'));
            } else if (modell === 4) {
                const preise = [];
                for (let i = 0; i < 24; i++) {
                    preise.push(parseFloat(formData.get(`preis_${i}`)));
                }
                data.preise = preise;
                data.min_preis_differenz = parseFloat(formData.get('min_preis_differenz'));
                data.always_allow_discharge_limit = parseFloat(formData.get('always_allow_discharge_limit')) / 100.0;
                data.max_charging_from_grid_limit = parseFloat(formData.get('max_charging_from_grid_limit')) / 100.0;
            }
            
            try {
                const response = await fetch('/berechnen', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(data)
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    zeigeErgebnis(result);
                } else {
                    zeigeError(result.error || 'Ein Fehler ist aufgetreten');
                }
            } catch (error) {
                zeigeError('Verbindungsfehler: ' + error.message);
            } finally {
                document.getElementById('loading').style.display = 'none';
            }
        });
        
        function zeigeErgebnis(result) {
            const ergebnisDiv = document.getElementById('ergebnis');
            const modell = parseInt(document.getElementById('modell').value);
            
            let html = `
                <div class="result-card">
                    <h3>üí∞ Gesamtkosten</h3>
                    <div class="value">${result.gesamtkosten.toFixed(2)} ‚Ç¨</div>
                </div>`;
            
            // F√ºr Modell 2 & 3: Gewichteten Durchschnittspreis anzeigen
            if ((modell === 2 || modell === 3) && result.gewichteter_preis !== undefined) {
                html += `
                <div class="result-card" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);">
                    <h3>üìä Gewichteter Durchschnittspreis</h3>
                    <div class="value">${result.gewichteter_preis.toFixed(4)} ‚Ç¨/kWh</div>
                    <p style="margin-top: 15px; font-size: 1em;">
                        Gesamt Netzbezug: ${result.gesamt_netzbezug_kwh} kWh
                    </p>`;
                
                // F√ºr Modell 3: Optimierungsstatus anzeigen
                if (modell === 3 && result.optimierungsstatus) {
                    html += `
                    <p style="margin-top: 10px; font-size: 0.9em; opacity: 0.9;">
                        üéØ Optimierungsstatus: ${result.optimierungsstatus}
                    </p>`;
                }
                
                html += `
                </div>`;
            }
            
            html += `
                <div class="section">
                    <h2>üìä Diagramme - Zeitreihen-Visualisierung</h2>
                    <div class="charts-container">
                        <div class="chart-wrapper">
                            <h3>üí∞ Preisverlauf (‚Ç¨/kWh)</h3>
                            <div class="chart-canvas">
                                <canvas id="preisChart"></canvas>
                            </div>
                        </div>
                        
                        <div class="chart-wrapper">
                            <h3>‚òÄÔ∏è PV-Produktion (Wh)</h3>
                            <div class="chart-canvas">
                                <canvas id="pvProduktionChart"></canvas>
                            </div>
                        </div>

                        <div class="chart-wrapper">
                            <h3>üîå Strombezug (Wh)</h3>
                            <div class="chart-canvas">
                                <canvas id="bezugChart"></canvas>
                            </div>
                        </div>
                        
                        <div class="chart-wrapper">
                            <h3>üîã Batteriestand (Wh)</h3>
                            <div class="chart-canvas">
                                <canvas id="batterieChart"></canvas>
                            </div>
                        </div>
                        
                        <div class="chart-wrapper">
                            <h3>üí∂ Kosten pro Stunde (‚Ç¨)</h3>
                            <div class="chart-canvas">
                                <canvas id="kostenChart"></canvas>
                            </div>
                        </div>
                        
                        <div class="chart-wrapper">
                            <h3>‚ö° Leistungs√ºbersicht (Wh)</h3>
                            <div class="chart-canvas">
                                <canvas id="uebersichtChart"></canvas>
                            </div>
                        </div>
                    
                    </div>
                </div>
                
                <div class="section">
                    <h2>üìà Zeitreihen-Auswertung (24 Stunden)</h2>
                    <table>
                        <thead>
                            <tr>
                                <th>Stunde</th>
                                <th>Netzbezug (Wh)</th>`;
            
            // Netzeinspeisung nur f√ºr Modell 4
            if (modell === 4 && result.netzeinspeisung) {
                html += `<th>Netzeinspeisung (Wh)</th>`;
            }
            
            html += `
                                <th>Batteriebezug (Wh)</th>
                                <th>Batteriestand (Wh)</th>`;
            
            // Preisspalte nur f√ºr Modell 2, 3 & 4
            if ((modell === 2 || modell === 3 || modell === 4) && result.preise) {
                html += `<th>Preis (‚Ç¨/kWh)</th>`;
            }
            
            // Modus-Spalte nur f√ºr Modell 4
            if (modell === 4 && result.modi) {
                html += `<th>Modus</th>`;
            }
            
            html += `
                                <th>Kosten (‚Ç¨)</th>
                            </tr>
                        </thead>
                        <tbody>
            `;
            
            for (let i = 0; i < 24; i++) {
                html += `
                    <tr>
                        <td><strong>${String(i).padStart(2, '0')}:00</strong></td>
                        <td>${result.netzbezug[i]}</td>`;
                
                // Netzeinspeisung nur f√ºr Modell 4
                if (modell === 4 && result.netzeinspeisung) {
                    html += `<td>${result.netzeinspeisung[i]}</td>`;
                }
                
                html += `
                        <td>${result.batteriebezug[i]}</td>
                        <td>${result.batterie_stand[i]}</td>`;
                
                // Preisspalte nur f√ºr Modell 2, 3 & 4
                if ((modell === 2 || modell === 3 || modell === 4) && result.preise) {
                    html += `<td>${result.preise[i]}</td>`;
                }
                
                // Modus-Spalte nur f√ºr Modell 4
                if (modell === 4 && result.modi) {
                    const modusText = result.modi[i] === -1 ? 'LADEN' : 
                                     result.modi[i] === 0 ? 'STOP' : 'NORMAL';
                    html += `<td>${modusText}</td>`;
                }
                
                html += `
                        <td>${result.kosten_pro_stunde[i].toFixed(4)}</td>
                    </tr>
                `;
            }
            
            html += `
                        </tbody>
                    </table>
                </div>
            `;
            
            ergebnisDiv.innerHTML = html;
            
            // Diagramme erstellen nach DOM-Update
            setTimeout(() => {
                erstelleDiagramme(result);
            }, 100);
        }
        
        function erstelleDiagramme(result) {
            const stunden = Array.from({length: 24}, (_, i) => `${String(i).padStart(2, '0')}:00`);
            
            // Chart 1: Strombezug (Netz vs Batterie)
            const ctx1 = document.getElementById('bezugChart');
            new Chart(ctx1, {
                type: 'bar',
                data: {
                    labels: stunden,
                    datasets: [
                        {
                            label: 'Netzbezug',
                            data: result.netzbezug,
                            backgroundColor: 'rgba(255, 99, 132, 0.7)',
                            borderColor: 'rgba(255, 99, 132, 1)',
                            borderWidth: 1
                        },
                        {
                            label: 'Batteriebezug',
                            data: result.batteriebezug,
                            backgroundColor: 'rgba(54, 162, 235, 0.7)',
                            borderColor: 'rgba(54, 162, 235, 1)',
                            borderWidth: 1
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Leistung (Wh)'
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'Uhrzeit'
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            position: 'top',
                        }
                    }
                }
            });
            
            // Chart 2: Batteriestand
            const ctx2 = document.getElementById('batterieChart');
            new Chart(ctx2, {
                type: 'line',
                data: {
                    labels: stunden,
                    datasets: [{
                        label: 'Batteriestand',
                        data: result.batterie_stand,
                        backgroundColor: 'rgba(75, 192, 192, 0.2)',
                        borderColor: 'rgba(75, 192, 192, 1)',
                        borderWidth: 2,
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Batteriestand (Wh)'
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'Uhrzeit'
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            position: 'top',
                        }
                    }
                }
            });
            
            // Chart 3: Kosten pro Stunde
            const ctx3 = document.getElementById('kostenChart');
            new Chart(ctx3, {
                type: 'bar',
                data: {
                    labels: stunden,
                    datasets: [{
                        label: 'Kosten',
                        data: result.kosten_pro_stunde,
                        backgroundColor: 'rgba(255, 206, 86, 0.7)',
                        borderColor: 'rgba(255, 206, 86, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Kosten (‚Ç¨)'
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'Uhrzeit'
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            position: 'top',
                        }
                    }
                }
            });
            
            // Chart 4: √úbersicht kombiniert
            const ctx4 = document.getElementById('uebersichtChart');
            new Chart(ctx4, {
                type: 'line',
                data: {
                    labels: stunden,
                    datasets: [
                        {
                            label: 'Netzbezug',
                            data: result.netzbezug,
                            borderColor: 'rgba(255, 99, 132, 1)',
                            backgroundColor: 'rgba(255, 99, 132, 0.1)',
                            borderWidth: 2,
                            tension: 0.4,
                            fill: false
                        },
                        {
                            label: 'Batteriebezug',
                            data: result.batteriebezug,
                            borderColor: 'rgba(54, 162, 235, 1)',
                            backgroundColor: 'rgba(54, 162, 235, 0.1)',
                            borderWidth: 2,
                            tension: 0.4,
                            fill: false
                        },
                        {
                            label: 'Batteriestand',
                            data: result.batterie_stand,
                            borderColor: 'rgba(75, 192, 192, 1)',
                            backgroundColor: 'rgba(75, 192, 192, 0.1)',
                            borderWidth: 2,
                            tension: 0.4,
                            fill: false,
                            yAxisID: 'y1'
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        mode: 'index',
                        intersect: false,
                    },
                    scales: {
                        y: {
                            type: 'linear',
                            display: true,
                            position: 'left',
                            title: {
                                display: true,
                                text: 'Bezug (Wh)'
                            },
                            beginAtZero: true
                        },
                        y1: {
                            type: 'linear',
                            display: true,
                            position: 'right',
                            title: {
                                display: true,
                                text: 'Batteriestand (Wh)'
                            },
                            beginAtZero: true,
                            grid: {
                                drawOnChartArea: false,
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'Uhrzeit'
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            position: 'top',
                        }
                    }
                }
            });
            
            // Chart 5: Preisverlauf
            const modell = parseInt(document.getElementById('modell').value);
            if ((modell === 2 || modell === 3 || modell === 4) && result.preise) {
                const ctx5 = document.getElementById('preisChart');
                new Chart(ctx5, {
                    type: 'line',
                    data: {
                        labels: stunden,
                        datasets: [{
                            label: 'Strompreis',
                            data: result.preise,
                            backgroundColor: 'rgba(153, 102, 255, 0.2)',
                            borderColor: 'rgba(153, 102, 255, 1)',
                            borderWidth: 3,
                            fill: true,
                            tension: 0.4,
                            pointRadius: 4,
                            pointHoverRadius: 6
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                beginAtZero: false,
                                title: {
                                    display: true,
                                    text: 'Preis (‚Ç¨/kWh)'
                                }
                            },
                            x: {
                                title: {
                                    display: true,
                                    text: 'Uhrzeit'
                                }
                            }
                        },
                        plugins: {
                            legend: {
                                position: 'top',
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        return 'Preis: ' + context.parsed.y.toFixed(4) + ' ‚Ç¨/kWh';
                                    }
                                }
                            }
                        }
                    }
                });
            }
            
            // Chart 6: PV-Produktion
            if (result.pv_produktion) {
                const ctx6 = document.getElementById('pvProduktionChart');
                new Chart(ctx6, {
                    type: 'bar',
                    data: {
                        labels: stunden,
                        datasets: [{
                            label: 'PV-Erzeugung',
                            data: result.pv_produktion,
                            backgroundColor: 'rgba(255, 159, 64, 0.7)',
                            borderColor: 'rgba(255, 159, 64, 1)',
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                beginAtZero: true,
                                title: {
                                    display: true,
                                    text: 'Leistung (Wh)'
                                }
                            },
                            x: {
                                title: {
                                    display: true,
                                    text: 'Uhrzeit'
                                }
                            }
                        },
                        plugins: {
                            legend: {
                                position: 'top',
                            }
                        }
                    }
                });
            }
        }
        
        function zeigeError(message) {
            const ergebnisDiv = document.getElementById('ergebnis');
            ergebnisDiv.innerHTML = `
                <div class="error">
                    <strong>‚ùå Fehler:</strong> ${message}
                </div>
            `;
        }
    </script>
</body>
</html>
